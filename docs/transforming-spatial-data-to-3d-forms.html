<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Transforming spatial data to 3D forms | Computational graphics structures for geo-spatial data</title>
  <meta name="description" content="Converting geo-spatial data into meshes suitable for computational graphics systems." />
  <meta name="generator" content="bookdown 0.13 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Transforming spatial data to 3D forms | Computational graphics structures for geo-spatial data" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Converting geo-spatial data into meshes suitable for computational graphics systems." />
  <meta name="github-repo" content="mdsumner/geo-comp-graphics-oghub" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Transforming spatial data to 3D forms | Computational graphics structures for geo-spatial data" />
  
  <meta name="twitter:description" content="Converting geo-spatial data into meshes suitable for computational graphics systems." />
  

<meta name="author" content="Michael Sumner" />


<meta name="date" content="2019-08-29" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="the-rgl-mesh3d-format.html"/>

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-1.3/htmlwidgets.js"></script>
<link href="libs/rglwidgetClass-2/rgl.css" rel="stylesheet" />
<script src="libs/rglwidgetClass-2/rglClass.src.js"></script>
<script src="libs/CanvasMatrix4-2016/CanvasMatrix.src.js"></script>
<script src="libs/rglWebGL-binding-0.100.30/rglWebGL.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Computational graphics structures for geo-spatial data inR</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About this</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#description-and-objectives"><i class="fa fa-check"></i><b>1.1</b> Description and objectives</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="getting-set-up.html"><a href="getting-set-up.html"><i class="fa fa-check"></i><b>2</b> Getting Set Up</a></li>
<li class="chapter" data-level="3" data-path="d-and-mesh-forms-of-spatial-data.html"><a href="d-and-mesh-forms-of-spatial-data.html"><i class="fa fa-check"></i><b>3</b> 3D and mesh forms of spatial data</a><ul>
<li class="chapter" data-level="3.1" data-path="d-and-mesh-forms-of-spatial-data.html"><a href="d-and-mesh-forms-of-spatial-data.html#questions"><i class="fa fa-check"></i><b>3.1</b> Questions</a></li>
<li class="chapter" data-level="3.2" data-path="d-and-mesh-forms-of-spatial-data.html"><a href="d-and-mesh-forms-of-spatial-data.html#what-is-a-mesh"><i class="fa fa-check"></i><b>3.2</b> What is a mesh?</a></li>
<li class="chapter" data-level="3.3" data-path="d-and-mesh-forms-of-spatial-data.html"><a href="d-and-mesh-forms-of-spatial-data.html#geospatial-data"><i class="fa fa-check"></i><b>3.3</b> Geospatial data</a></li>
<li class="chapter" data-level="3.4" data-path="d-and-mesh-forms-of-spatial-data.html"><a href="d-and-mesh-forms-of-spatial-data.html#primitives"><i class="fa fa-check"></i><b>3.4</b> Primitives</a></li>
<li class="chapter" data-level="3.5" data-path="d-and-mesh-forms-of-spatial-data.html"><a href="d-and-mesh-forms-of-spatial-data.html#a-raster-is-a-mesh-implicitly"><i class="fa fa-check"></i><b>3.5</b> A raster is a mesh (implicitly)</a></li>
<li class="chapter" data-level="3.6" data-path="d-and-mesh-forms-of-spatial-data.html"><a href="d-and-mesh-forms-of-spatial-data.html#summary"><i class="fa fa-check"></i><b>3.6</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="the-rgl-mesh3d-format.html"><a href="the-rgl-mesh3d-format.html"><i class="fa fa-check"></i><b>4</b> the rgl mesh3d format</a><ul>
<li class="chapter" data-level="4.1" data-path="the-rgl-mesh3d-format.html"><a href="the-rgl-mesh3d-format.html#exercise-1"><i class="fa fa-check"></i><b>4.1</b> Exercise 1</a><ul>
<li class="chapter" data-level="4.1.1" data-path="the-rgl-mesh3d-format.html"><a href="the-rgl-mesh3d-format.html#ex-1-answer"><i class="fa fa-check"></i><b>4.1.1</b> EX 1 ANSWER</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="the-rgl-mesh3d-format.html"><a href="the-rgl-mesh3d-format.html#rgl-miscellanea"><i class="fa fa-check"></i><b>4.2</b> rgl miscellanea</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="transforming-spatial-data-to-3d-forms.html"><a href="transforming-spatial-data-to-3d-forms.html"><i class="fa fa-check"></i><b>5</b> Transforming spatial data to 3D forms</a><ul>
<li class="chapter" data-level="5.1" data-path="transforming-spatial-data-to-3d-forms.html"><a href="transforming-spatial-data-to-3d-forms.html#tools"><i class="fa fa-check"></i><b>5.1</b> Tools</a></li>
<li class="chapter" data-level="5.2" data-path="transforming-spatial-data-to-3d-forms.html"><a href="transforming-spatial-data-to-3d-forms.html#quadmesh."><i class="fa fa-check"></i><b>5.2</b> Quadmesh.</a><ul>
<li class="chapter" data-level="5.2.1" data-path="transforming-spatial-data-to-3d-forms.html"><a href="transforming-spatial-data-to-3d-forms.html#comparison-of-discrete-elevation-extrusion-vs-continuous"><i class="fa fa-check"></i><b>5.2.1</b> comparison of discrete elevation (extrusion) vs continuous</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="transforming-spatial-data-to-3d-forms.html"><a href="transforming-spatial-data-to-3d-forms.html#image-textures"><i class="fa fa-check"></i><b>5.3</b> Image textures</a></li>
<li class="chapter" data-level="5.4" data-path="transforming-spatial-data-to-3d-forms.html"><a href="transforming-spatial-data-to-3d-forms.html#various-tools"><i class="fa fa-check"></i><b>5.4</b> Various tools</a></li>
<li class="chapter" data-level="5.5" data-path="transforming-spatial-data-to-3d-forms.html"><a href="transforming-spatial-data-to-3d-forms.html#triangles-or-quads-from-geospatial"><i class="fa fa-check"></i><b>5.5</b> Triangles or quads from geospatial</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/mdsumner/geo-comp-graphics-oghub" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Computational graphics structures for geo-spatial data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="transforming-spatial-data-to-3d-forms" class="section level1">
<h1><span class="header-section-number">Chapter 5</span> Transforming spatial data to 3D forms</h1>
<ul>
<li>What tools exist to convert data to meshes in R?</li>
<li>What forms of mesh data are available?</li>
</ul>
<p>The key package is rgl, the OpenGL package for R. This tends to be very low level, but has improved helpers and is becoming easier to use. The key functions are <code>plot3d()</code>, <code>lines3d()</code> and <code>points3d()</code> and these are used just like the 2D base funtions in R (with the ‘3d’ on the end).</p>
<p>For polygons we first need to create triangles, and then use <code>triangle3d()</code>. For rasters we can create triangles or quads, and use <code>quads3d()</code>. There is also a mesh type object, <code>mesh3d</code> to store data with material properties. To plot <code>mesh3d</code> we use the <code>shade3d()</code> function.</p>
<div id="tools" class="section level2">
<h2><span class="header-section-number">5.1</span> Tools</h2>
<p>Converting points to 3D is really trivial, we only need the X-Y-Z coordinates, and we can set properties directly on them.</p>
<p>Converting lines is also relatively easy, but here we might use a <em>path</em> model, sequential lists of coordinates that imply a connected line, or a <em>segments</em> model where every single individual line segment is specified separately. The segment model is really a mesh, because we have the opportunity to store every coordinate just once and refer to segments by their index.</p>
<p>Converting polygons is much harder, and there are multiple ways to do it. The main division is by near-Delaunay triangulation, or by ear-cutting algorithms.</p>
<ul>
<li>near-Delaunay - high quality triangulations, suitable for surface modelling</li>
<li>ear-cutting - low quality triangulation, suitable for flat surfaces</li>
</ul>
<p>The main tools available for geospatial data:</p>
<ul>
<li><strong>quadmesh</strong> (on CRAN) - convert any raster to mesh3d quads, optionally with image textures</li>
<li><strong>anglr</strong> (not on CRAN) - convert any sp, sf lines or polygons to mesh3d triangles</li>
</ul>
<p>The <code>rgl</code> package has ear-cutting in <code>triangulate3d()</code>.</p>
<p>The <code>sfdct</code> package (via <code>RTriangle</code>) has near-Delaunay in <code>ct_triangulate()</code></p>
<p>The <code>decido</code> package has ear-cutting in <code>earcut()</code>.</p>
<p>Converting raster data is available in various ways.</p>
<ul>
<li><code>rgl::surface3d()</code>, this is analogous to the old base <code>image()</code> function that can take <code>x, y, z = matrix</code></li>
<li><code>quadmesh::quadmesh()</code>, converts raster, matrix, some stars to <code>mesh3d</code></li>
<li>rayshader determines elevation colouring from a matrix, and has many plotting helpers</li>
</ul>
</div>
<div id="quadmesh." class="section level2">
<h2><span class="header-section-number">5.2</span> Quadmesh.</h2>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="kw">library</span>(quadmesh)</a>
<a class="sourceLine" id="cb37-2" data-line-number="2"><span class="kw">quadmesh</span>(anyRasterDEM, <span class="dt">texture =</span> anyRasterRGB)</a>
<a class="sourceLine" id="cb37-3" data-line-number="3">rgl<span class="op">::</span><span class="kw">shade3d</span>()</a>
<a class="sourceLine" id="cb37-4" data-line-number="4"></a>
<a class="sourceLine" id="cb37-5" data-line-number="5"><span class="co">## play with aspect3d, light3d, ...</span></a></code></pre></div>
<p>Triangulations, <code>sfdct</code> is no good because it’s very inefficient. <code>sf</code> is simply not suitable for mesh (a.k.a. <em>indexed</em>) forms of data.</p>
<div id="comparison-of-discrete-elevation-extrusion-vs-continuous" class="section level3">
<h3><span class="header-section-number">5.2.1</span> comparison of discrete elevation (extrusion) vs continuous</h3>
<p><a href="http://rpubs.com/cyclemumner/geomesh-r" class="uri">http://rpubs.com/cyclemumner/geomesh-r</a></p>
</div>
</div>
<div id="image-textures" class="section level2">
<h2><span class="header-section-number">5.3</span> Image textures</h2>
<p>This section requires a Mapbox API key to run from scratch - and can’t be shared, so it will simply be illustrated.</p>
<p>Munster is here.</p>
<p>The process is a little complicated, but the key is that the elevation raster provides a space in which to map other data too. In this case the raster is in Mercator, and the image is as well. Under the hood we have to map the spatial part of the image into 0, 1, 0, 1 space of a PNG image, but in the final event we get a scene where real-world data may be added directly.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1">munster_qmesh &lt;-<span class="st"> </span>quadmesh<span class="op">::</span><span class="kw">quadmesh</span>(munster_elev, <span class="dt">texture =</span> munster_imag)</a>
<a class="sourceLine" id="cb38-2" data-line-number="2"></a>
<a class="sourceLine" id="cb38-3" data-line-number="3">rgl<span class="op">::</span><span class="kw">shade3d</span>(munster_qmesh, <span class="dt">lit =</span> <span class="ot">FALSE</span>); rgl<span class="op">::</span><span class="kw">aspect3d</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">.05</span>)</a>
<a class="sourceLine" id="cb38-4" data-line-number="4"></a>
<a class="sourceLine" id="cb38-5" data-line-number="5"><span class="co">## more exact location of THIS building</span></a>
<a class="sourceLine" id="cb38-6" data-line-number="6">merc &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw">sf_project</span>(<span class="kw">cbind</span>(<span class="fl">7.59551</span>, <span class="fl">51.96922</span>), <span class="dt">from =</span> <span class="st">&quot;+init=epsg:4326&quot;</span>, <span class="dt">to =</span> raster<span class="op">::</span><span class="kw">projection</span>(munster_elev))</a>
<a class="sourceLine" id="cb38-7" data-line-number="7">rgl<span class="op">::</span><span class="kw">lines3d</span>(<span class="kw">cbind</span>(merc[<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), ], <span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1000</span>))))</a></code></pre></div>
</div>
<div id="various-tools" class="section level2">
<h2><span class="header-section-number">5.4</span> Various tools</h2>
<ul>
<li><p><code>rgl::triangulate</code> and <code>decido::earcut</code> will triangulate polygons with holes but only suitable for plane-filling, because ugly triangles, no control over size and shape.</p></li>
<li><p><code>RTriangle::triangulate</code> (and <code>sfdct::ct_triangulate</code>) do high-quality “near-Delaunay” triangulations</p></li>
<li><p><code>quadmesh::quadmesh()</code> to create rgl-ready mesh3d from a raster</p></li>
<li><p><code>mapview::cubeView()</code> does very compelling interactive raster-cube visualization</p></li>
<li><p><code>SymbolixAU/mapdeck()</code> an alternative 3D viewer using Uber’s <code>deck.gl</code></p></li>
<li><p><code>tylermorganwall/rayshader</code></p></li>
<li><p><code>Rvcg</code> package on CRAN</p></li>
</ul>
<p>Side note: there are many triangulation algorithms and many packages in R, but we need <em>constrained triangulation</em> to preserve all input edges - only a handful can do that, and RTriangle is the king (with a problematic license).</p>
<ul>
<li><p><code>hypertidy/silicate</code>, <code>hypertidy/anglr</code> - these are evolving together</p></li>
<li><p><a href="https://github.com/MilesMcBain/gis_vs_web3D" class="uri">https://github.com/MilesMcBain/gis_vs_web3D</a></p></li>
<li><p><code>coolbutuseless/threed</code></p></li>
</ul>
<p>There are a few example data packages:</p>
<p>.obj format: <a href="https://github.com/odedstein/meshes/tree/master/objects/koala" class="uri">https://github.com/odedstein/meshes/tree/master/objects/koala</a></p>
</div>
<div id="triangles-or-quads-from-geospatial" class="section level2">
<h2><span class="header-section-number">5.5</span> Triangles or quads from geospatial</h2>
<p>This is my work-in-progress approach to meshing any data structure.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1"><span class="co">## devtools::install_github(&quot;hypertidy/anglr&quot;)</span></a>
<a class="sourceLine" id="cb39-2" data-line-number="2"><span class="co">## devtools::install_github(&quot;hypertidy/silicate&quot;)</span></a>
<a class="sourceLine" id="cb39-3" data-line-number="3"><span class="kw">library</span>(anglr)  </a>
<a class="sourceLine" id="cb39-4" data-line-number="4">triangles &lt;-<span class="st"> </span><span class="kw">copy_down</span>(<span class="kw">TRI</span>(anySFpolygon), anyRasterDEM)</a>
<a class="sourceLine" id="cb39-5" data-line-number="5"></a>
<a class="sourceLine" id="cb39-6" data-line-number="6">mesh &lt;-<span class="st"> </span><span class="kw">plot3d</span>(triangles)</a></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="the-rgl-mesh3d-format.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/mdsumner/geo-comp-graphics-oghub/edit/master/04_geospatial-to-mesh.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
